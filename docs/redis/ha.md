---
date: 2024-02-02
categories:
  - Redis
search:
  boost: 2
hide:
  - footer
---

## 主从复制

主从复制是 Redis 高可用服务的最基础的保证，实现方案就是将从前的一台 Redis 服务器，同步数据到多台从 Redis 服务器上，即**一主多从的模式**，且**主从服务器之间采用的是「读写分离」的方式**。

所有的数据修改只在主服务器上进行，然后将最新的数据同步给从服务器，这样就使得主从服务器的数据是一致的。

<center>
![](../assets/img/redis/master_slave_copy.webp){width=50%}
</center>

主从复制共有三种模式：**全量复制、基于长连接的命令传播、增量复制**。

- **主从服务器第一次同步的时候，就是采用全量复制**，此时主服务器会两个耗时的地方，分别是生成 RDB 文件和传输 RDB 文件。为了避免过多的从服务器和主服务器进行全量复制，可以把一部分从服务器升级为「经理角色」，让它也有自己的从服务器，通过这样可以分摊主服务器的压力。
- 第一次同步完成后，**主从服务器都会维护着一个长连接**，主服务器在接收到写操作命令后，就会**通过这个连接将写命令传播给从服务器**，来保证主从服务器的数据一致性。
- 如果遇到**网络断开**，**增量复制**就可以上场了，不过这个还跟 repl_backlog_size 这个大小有关系。

## 哨兵机制

Redis 在 2.8 版本以后提供的**哨兵（Sentinel）机制**，它的作用是实现**主从节点故障转移**。它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端。

主从服务器之间的命令复制是异步进行的。

### 哨兵机制如何工作？

哨兵其实是一个运行在特殊模式下的 Redis 进程，所以它也是一个节点。从“哨兵”这个名字也可以看得出来，它**相当于是“观察者节点”，观察的对象是主从节点**。

哨兵一般是以集群的方式部署，至少需要 3 个哨兵节点，哨兵集群主要负责三件事情：**监控、选主、通知**。

!!!tip

    为了减少误判的情况，哨兵在部署的时候不会只部署一个节点，而是**用多个节点部署成哨兵集群（最少需要三台机器来部署哨兵集群）**，通过多个哨兵节点一起判断，就可以就可以避免单个哨兵因为自身网络状况不好，而误判主节点下线的情况。

哨兵集群中会选出一个 leader，让 leader 来执行主从切换。

哨兵节点通过 Redis 的发布者/订阅者机制，哨兵之间可以相互感知，相互连接，然后组成哨兵集群，同时哨兵又通过 INFO 命令，在主节点里获得了所有从节点连接信息，于是就能和从节点建立连接，并进行监控了。

**1、第一轮投票：判断主节点下线**

当哨兵集群中的某个哨兵判定主节点下线（主观下线）后，就会向其他哨兵发起命令，其他哨兵收到这个命令后，就会根据自身和主节点的网络状况，做出赞成投票或者拒绝投票的响应。

当这个哨兵的赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，这时主节点就会被该哨兵标记为「客观下线」。

**2、第二轮投票：选出哨兵 leader**

某个哨兵判定主节点客观下线后，该哨兵就会发起投票，告诉其他哨兵，它想成为 leader，想成为 leader 的哨兵节点，要满足两个条件：

第一，拿到半数以上的赞成票；
第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。

**3、由哨兵 leader 进行主从故障转移**

选举出了哨兵 leader 后，就可以进行主从故障转移的过程了。该操作包含以下四个步骤：

- 第一步：在已下线主节点（旧主节点）属下的所有「从节点」里面，挑选出一个从节点，并将其转换为主节点，选择的规则：过滤掉已经离线的从节点；过滤掉历史网络连接状态不好的从节点；将剩下的从节点，进行三轮考察：优先级、复制进度、ID 号。在每一轮考察过程中，如果找到了一个胜出的从节点，就将其作为新主节点。
- 第二步：让已下线主节点属下的所有「从节点」修改复制目标，修改为复制「新主节点」；
- 第三步：将新主节点的 IP 地址和信息，通过「发布者/订阅者机制」通知给客户端；
- 第四步：继续监视旧主节点，当这个旧主节点重新上线时，将它设置为新主节点的从节点；

---
## 参考

- [小林 coding - 图解 Redis：主从复制是怎么实现的？](https://xiaolincoding.com/redis/cluster/master_slave_replication.html)
- [小林 coding - 图解 Redis：为什么要有哨兵？](https://xiaolincoding.com/redis/cluster/master_slave_replication.html)
